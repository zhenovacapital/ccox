<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mining - CCOX</title>
    <link rel="icon" type="image/png" href="../assets/images/CCOX.png" />

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
      body {
        font-family: 'Plus Jakarta Sans', sans-serif;
        background-color: #0f172a; /* Slate 900 */
        color: #f8fafc;
      }

      .glass-card {
        background: rgba(30, 41, 59, 0.7);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.05);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .glass-card:hover {
        border-color: rgba(16, 185, 129, 0.3);
        transform: translateY(-2px);
      }

      .btn-primary {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        box-shadow: 0 4px 14px 0 rgba(16, 185, 129, 0.39);
      }

      .fade-in {
        animation: fadeIn 0.5s ease-out forwards;
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }

      /* Custom Scrollbar */
      ::-webkit-scrollbar { width: 6px; }
      ::-webkit-scrollbar-track { background: #0f172a; }
      ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }

      .progress-glow {
        box-shadow: 0 0 15px rgba(99, 102, 241, 0.4);
      }
    </style>
  </head>
  <body class="min-h-screen">

    <!-- Toast Notification -->
    <div
      id="toast"
      class="fixed bottom-8 right-8 z-[100] bg-emerald-600 px-6 py-3 rounded-xl shadow-2xl border border-emerald-400 pointer-events-none opacity-0 transition-all duration-300 transform translate-y-10"
    >
      <p id="toast-msg" class="font-bold text-white"></p>
    </div>

    <!-- Sidebar -->
    <div
      id="sidebar"
      class="w-64 bg-gray-900 h-screen fixed left-0 top-0 z-40 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out"
    ></div>

    <!-- Main Wrapper -->
    <div class="md:ml-64 min-h-screen flex flex-col">
      
      <!-- Header Placeholder -->
      <header id="header" class="h-16 border-b border-slate-800 sticky top-0 bg-slate-900/80 backdrop-blur-md z-30"></header>

      <!-- Main Content -->
      <main class="flex-grow p-6 lg:p-10 max-w-6xl mx-auto w-full">
        
        <!-- Page Title -->
        <div class="mb-10 fade-in">
            <h1 class="text-4xl font-bold tracking-tight">Mining Hub <span class="text-emerald-500">.</span></h1>
            <p class="text-slate-400 mt-2">Manage your mining operations and track rewards.</p>
        </div>

        <!-- Mining Action Section -->
        <section class="mb-12 fade-in" style="animation-delay: 0.1s;">
          <div class="glass-card p-8 rounded-3xl relative overflow-hidden">
            <div class="absolute top-0 right-0 w-64 h-64 bg-emerald-500/10 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>
            
            <div class="flex flex-col md:flex-row justify-between gap-8 mb-8 relative z-10">
              <div class="flex-1">
                <h3 class="text-xl font-bold text-white mb-2 flex items-center gap-2">
                  <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                  Active Session
                </h3>
                <p class="text-slate-400 text-sm leading-relaxed">
                  Mining runs for 24 hours. Complete the cycle to earn <span class="text-emerald-400 font-bold">2.00 CCOX</span>.
                </p>
              </div>
              <div class="flex-shrink-0">
                <button
                  id="btn-start"
                  onclick="startMining()"
                  class="btn-primary px-8 py-4 rounded-2xl font-bold text-white shadow-lg transition-all hover:scale-105 active:scale-95 w-full md:w-auto"
                >
                  Start Mining
                </button>
                <button
                  id="btn-claim"
                  onclick="claimReward()"
                  class="hidden bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-4 px-8 rounded-2xl shadow-lg animate-bounce w-full md:w-auto"
                >
                  Claim 2 CCOX
                </button>
              </div>
            </div>

            <div class="space-y-4 relative z-10">
              <div class="flex justify-between items-end">
                <span id="status-text" class="text-slate-400 text-xs font-bold uppercase tracking-wider">System Idle</span>
                <span id="timer-display" class="text-2xl font-mono font-bold text-white">00:00:00</span>
              </div>
              <div class="h-3 w-full bg-slate-900/50 rounded-full overflow-hidden border border-slate-700/50">
                <div id="progress-bar" class="h-full bg-gradient-to-r from-emerald-500 to-teal-400 progress-glow transition-all w-0"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- Stats Grid -->
        <section class="mb-12 fade-in" style="animation-delay: 0.2s;">
          <h2 class="text-sm font-semibold uppercase tracking-widest text-slate-500 mb-5">Performance Stats</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            
            <!-- Status Card -->
            <div class="glass-card p-6 rounded-3xl relative overflow-hidden group">
              <div class="absolute -right-4 -top-4 w-20 h-20 bg-blue-500/10 rounded-full blur-xl group-hover:bg-blue-500/20 transition-all"></div>
              <h3 class="text-slate-400 text-xs font-bold uppercase mb-2">Mining Status</h3>
              <div class="flex items-center gap-2">
                <span id="mining-status" class="text-2xl font-bold text-white">Inactive</span>
              </div>
            </div>

            <!-- Hashrate Card -->
            <div class="glass-card p-6 rounded-3xl relative overflow-hidden group">
              <div class="absolute -right-4 -top-4 w-20 h-20 bg-purple-500/10 rounded-full blur-xl group-hover:bg-purple-500/20 transition-all"></div>
              <h3 class="text-slate-400 text-xs font-bold uppercase mb-2">Network Hashrate</h3>
              <div class="flex items-center gap-2">
                <span id="hashrate" class="text-2xl font-bold text-white">0.0 MH/s</span>
              </div>
            </div>

            <!-- Locked Balance Card -->
            <div class="glass-card p-6 rounded-3xl relative overflow-hidden group">
              <div class="absolute -right-4 -top-4 w-20 h-20 bg-amber-500/10 rounded-full blur-xl group-hover:bg-amber-500/20 transition-all"></div>
              <h3 class="text-slate-400 text-xs font-bold uppercase mb-2">Locked Balance</h3>
              <div class="flex items-center gap-2">
                <span id="locked-balance-stats" class="text-2xl font-bold text-amber-400">0.00</span>
                <span class="text-xs font-bold text-slate-500 mt-2">CCOX</span>
              </div>
              <!-- Hidden element for JS compatibility if needed -->
              <span id="locked-balance" class="hidden">0.00</span>
            </div>

            <!-- Wallet Balance Card -->
            <div class="glass-card p-6 rounded-3xl relative overflow-hidden group">
              <div class="absolute -right-4 -top-4 w-20 h-20 bg-emerald-500/10 rounded-full blur-xl group-hover:bg-emerald-500/20 transition-all"></div>
              <h3 class="text-slate-400 text-xs font-bold uppercase mb-2">Wallet Balance</h3>
              <div class="flex items-center gap-2">
                <span id="wallet-balance-stats" class="text-2xl font-bold text-emerald-400">0.00</span>
                <span class="text-xs font-bold text-slate-500 mt-2">CCOX</span>
              </div>
              <!-- Hidden element for JS compatibility if needed -->
              <span id="wallet-balance" class="hidden">0.00</span>
            </div>

          </div>
        </section>

        <!-- History Section -->
        <section class="fade-in" style="animation-delay: 0.3s;">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold">Mining History</h2>
          </div>
          <div class="glass-card rounded-3xl overflow-hidden border border-slate-800">
            <div class="overflow-x-auto">
              <table class="w-full text-left">
                <thead>
                  <tr class="bg-slate-800/50 text-slate-400 text-xs uppercase tracking-widest">
                    <th class="px-6 py-4">Date</th>
                    <th class="px-6 py-4">Duration</th>
                    <th class="px-6 py-4">Reward</th>
                    <th class="px-6 py-4">Status</th>
                  </tr>
                </thead>
                <tbody id="mining-history-table" class="divide-y divide-slate-800 text-sm">
                  <!-- Mining history will be populated here -->
                  <tr><td colspan="4" class="px-6 py-8 text-center text-slate-500 italic">Loading history...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

      </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <script src="../assets/js/supabase-config.js"></script>
    <script src="../assets/js/app.js"></script>
    <script>
      // Global State and Mining Logic (copied from dashboard)
      let currentUserId = null;
      let walletBalance = 0;
      let lockedBalance = 0;
      const MINING_TIME = 24 * 60 * 60 * 1000; // 24 Hours
      const timerDisplay = document.getElementById("timer-display");
      const progressBar = document.getElementById("progress-bar");
      const lockedDisplay = document.getElementById("locked-balance");
      const lockedStatsDisplay = document.getElementById(
        "locked-balance-stats"
      );
      const walletDisplay =
        document.getElementById("wallet-balance") ||
        document.getElementById("wallet-balance-stats");
      const statusText = document.getElementById("status-text");

      // Helper Functions for User-Specific Storage
      function getStorageKey(key) {
        if (!currentUserId) return key;
        return `${currentUserId}_${key}`;
      }

      function getStoredItem(key) {
        return localStorage.getItem(getStorageKey(key));
      }

      function setStoredItem(key, value) {
        localStorage.setItem(getStorageKey(key), value);
      }

      function removeStoredItem(key) {
        localStorage.removeItem(getStorageKey(key));
      }

      function init() {
        // User fetch is handled in updateUI mostly, but let's ensure we have ID for loops
        window.supabase.auth.getUser().then(({ data: { user } }) => {
          if (user) currentUserId = user.id;
          updateUI();
          startLoops();
          syncMiningState();
        });
      }

      async function updateUI() {
        // Try to fetch latest data from Supabase if logged in
        const {
          data: { user },
        } = await window.supabase.auth.getUser();
        if (user) {
          currentUserId = user.id;
          try {
            const profile = await window.SupabaseConfig.getUserProfile(user.id);
            if (profile) {
              walletBalance = profile.cco_x_balance || 0;
              lockedBalance = profile.locked_balance || 0;
              // Sync to localStorage
              setStoredItem("ccox_wallet", walletBalance);
              setStoredItem("ccox_locked", lockedBalance);
              loadMiningHistory(); // Load history when user is confirmed
            }
          } catch (e) {
            console.warn("Failed to fetch profile:", e);
          }
        } else {
          // Fallback to localStorage
          walletBalance = parseFloat(
            getStoredItem("ccox_wallet") || walletBalance
          );
          lockedBalance = parseFloat(
            getStoredItem("ccox_locked") || lockedBalance
          );
        }

        if (walletDisplay)
          walletDisplay.innerText = (
            isNaN(walletBalance) ? 0 : walletBalance
          ).toFixed(2);
        if (lockedDisplay)
          lockedDisplay.innerText = (
            isNaN(lockedBalance) ? 0 : lockedBalance
          ).toFixed(2);
        if (lockedStatsDisplay)
          lockedStatsDisplay.innerText = (
            isNaN(lockedBalance) ? 0 : lockedBalance
          ).toFixed(2);
      }
      function showToast(msg) {
        const toast = document.getElementById("toast");
        const toastMsg = document.getElementById("toast-msg");
        if (toast && toastMsg) {
          toastMsg.innerText = msg;
          toast.classList.remove("opacity-0", "translate-y-10");
          setTimeout(() => toast.classList.add("opacity-0", "translate-y-10"), 3000);
        }
      }

      async function syncMiningState() {
        const {
          data: { user },
        } = await window.supabase.auth.getUser();
        if (!user) return;

        try {
          const session = await window.SupabaseConfig.getActiveMiningSession(
            user.id
          );
          if (session) {
            const startTime = new Date(session.started_at).getTime();
            const endTime = startTime + MINING_TIME;
            setStoredItem("ccox_mining_end", endTime);
          } else {
            // If local storage has a future time but server has no active session, clear it
            const localEnd = getStoredItem("ccox_mining_end");
            if (localEnd && parseInt(localEnd) > Date.now()) {
              removeStoredItem("ccox_mining_end");
            }
          }
          updateUI();
        } catch (e) {
          console.warn("Sync mining error:", e);
        }
      }

      async function startMining() {
        const {
          data: { user },
        } = await window.supabase.auth.getUser();
        if (!user) return showToast("Please login to mine");

        try {
          const result = await window.SupabaseConfig.startMining(user.id);
          if (result.success) {
            const endTime = new Date(result.ends_at).getTime();
            setStoredItem("ccox_mining_end", endTime);
            showToast("Mining session started! See you in 24 hours.");
            updateUI();
          }
        } catch (e) {
          showToast("Failed to start mining: " + e.message);
        }
      }

      async function claimReward() {
        const {
          data: { user },
        } = await window.supabase.auth.getUser();
        if (!user) return showToast("Please login to claim");

        const btnClaim = document.getElementById("btn-claim");
        if (btnClaim) {
          btnClaim.disabled = true;
          btnClaim.innerText = "Claiming...";
        }

        try {
          const result = await window.SupabaseConfig.completeMining(user.id);
          if (result.success) {
            await window.SupabaseConfig.addToLockedBalance(
              user.id,
              result.reward
            );
            removeStoredItem("ccox_mining_end");

            const btnStart = document.getElementById("btn-start");
            if (btnClaim) btnClaim.classList.add("hidden");
            if (btnStart) btnStart.classList.remove("hidden");

            showToast(`+${result.reward} CCOX added to locked balance!`);
            updateUI();
          }
        } catch (e) {
          showToast("Error claiming reward: " + e.message);
          if (btnClaim) {
            btnClaim.disabled = false;
            btnClaim.innerText = "Claim 2 CCOX";
          }
        }
      }

      async function loadMiningHistory() {
        if (!currentUserId) return;
        try {
          const { data: sessions, error } = await window.supabase
            .from('mining_sessions')
            .select('*')
            .eq('user_id', currentUserId)
            .order('started_at', { ascending: false })
            .limit(10);

          if (error) throw error;

          const tbody = document.getElementById('mining-history-table');
          if (!tbody) return;
          tbody.innerHTML = '';

          if (!sessions || sessions.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="py-4 px-4 text-center text-slate-500">No mining history yet</td></tr>';
            return;
          }

          sessions.forEach(session => {
            const date = new Date(session.started_at).toLocaleDateString();
            const duration = session.completed_at 
              ? Math.round((new Date(session.completed_at) - new Date(session.started_at)) / (1000 * 60 * 60)) + 'h'
              : 'In Progress';
            const reward = session.reward_amount || 0;
            let statusClass = session.status === 'active' ? 'text-blue-400 font-bold' : (session.status === 'completed' ? 'text-emerald-400 font-bold' : 'text-slate-400');

            const row = `<tr class="hover:bg-slate-800/30 transition-colors"><td class="px-6 py-4 text-slate-300">${date}</td><td class="px-6 py-4 text-slate-300">${duration}</td><td class="px-6 py-4 font-mono text-emerald-400">+${reward}</td><td class="px-6 py-4 capitalize ${statusClass}">${session.status}</td></tr>`;
            tbody.innerHTML += row;
          });
        } catch (e) {
          console.error("History Error:", e);
        }
      }

      function startLoops() {
        setInterval(async () => {
          const now = Date.now();

          const miningEnd = getStoredItem("ccox_mining_end");
          const btnStart = document.getElementById("btn-start");
          const btnClaim = document.getElementById("btn-claim");
          const miningStatusEl = document.getElementById("mining-status");
          const hashrateEl = document.getElementById("hashrate");

          if (miningEnd) {
            const remaining = parseInt(miningEnd) - now;
            if (remaining <= 0) {
              if (timerDisplay) timerDisplay.innerText = "00:00:00";
              if (progressBar) progressBar.style.width = "100%";
              if (statusText) statusText.innerText = "Mining Complete";
              
              if (miningStatusEl) {
                miningStatusEl.innerText = "Completed";
                miningStatusEl.className = "text-2xl font-bold text-blue-400"; // Keep class update logic
              }
              if (hashrateEl) {
                hashrateEl.innerText = "0.0 MH/s";
              }

              if (btnStart) btnStart.classList.add("hidden");
              if (btnClaim) btnClaim.classList.remove("hidden");
            } else {
              if (statusText) statusText.innerText = "Mining in Progress...";
              
              if (miningStatusEl) {
                miningStatusEl.innerText = "Active";
                miningStatusEl.className = "text-2xl font-bold text-emerald-400";
              }
              if (hashrateEl) {
                // Simulate hashrate
                const rate = (145 + Math.random() * 10).toFixed(1);
                hashrateEl.innerText = rate + " MH/s";
              }

              if (btnStart) btnStart.classList.add("hidden");
              if (btnClaim) btnClaim.classList.add("hidden");
              const h = Math.floor(remaining / 3600000)
                .toString()
                .padStart(2, "0");
              const m = Math.floor((remaining % 3600000) / 60000)
                .toString()
                .padStart(2, "0");
              const s = Math.floor((remaining % 60000) / 1000)
                .toString()
                .padStart(2, "0");
              if (timerDisplay) timerDisplay.innerText = `${h}:${m}:${s}`;
              const percent = ((MINING_TIME - remaining) / MINING_TIME) * 100;
              if (progressBar) progressBar.style.width = percent + "%";
            }
          } else {
            if (statusText) statusText.innerText = "System Idle";
            
            if (miningStatusEl) {
              miningStatusEl.innerText = "Inactive";
              miningStatusEl.className = "text-2xl font-bold text-slate-400";
            }
            if (hashrateEl) {
              hashrateEl.innerText = "0.0 MH/s";
            }

            if (timerDisplay) timerDisplay.innerText = "00:00:00";
            if (progressBar) progressBar.style.width = "0%";
            if (btnStart) btnStart.classList.remove("hidden");
          }
        }, 1000);
      }
      window.onload = init;
    </script>
  </body>
</html>
hell