<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CCOX Referral</title>
    <link rel="icon" type="image/png" href="../assets/images/CCOX.png" />

    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: "Plus Jakarta Sans", sans-serif;
        background-color: #0f172a;
        color: #f8fafc;
      }

      .glass-card {
        background: rgba(30, 41, 59, 0.7);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.05);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .glass-card:hover {
        border-color: rgba(16, 185, 129, 0.3);
        transform: translateY(-2px);
      }

      .btn-primary {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        box-shadow: 0 4px 14px 0 rgba(16, 185, 129, 0.39);
      }

      .fade-in {
        animation: fadeIn 0.5s ease-out forwards;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Custom Scrollbar */
      ::-webkit-scrollbar {
        width: 6px;
      }
      ::-webkit-scrollbar-track {
        background: #0f172a;
      }
      ::-webkit-scrollbar-thumb {
        background: #334155;
        border-radius: 10px;
      }

      .gradient-text {
        background: linear-gradient(135deg, #34d399 0%, #059669 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
    </style>
  </head>
  <body class="min-h-screen">
    <!-- Toast Notification -->
    <div
      id="toast"
      class="fixed bottom-8 right-8 z-[100] bg-emerald-600 px-6 py-3 rounded-xl shadow-2xl border border-emerald-400 pointer-events-none opacity-0 transition-opacity duration-300"
    >
      <p id="toast-msg" class="font-bold text-white"></p>
    </div>

    <!-- Sidebar -->
    <div
      class="w-64 bg-gray-900 h-screen fixed left-0 top-0 z-40 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out"
      id="sidebar"
    ></div>

    <!-- Main content -->
    <div class="md:ml-64">
      <!-- Header Placeholder -->
      <header
        id="header"
        class="h-16 border-b border-slate-800 sticky top-0 bg-slate-900/80 backdrop-blur-md z-30"
      ></header>

      <!-- Main content -->
      <main class="flex-grow p-6 lg:p-10 max-w-6xl mx-auto w-full">
        <!-- Page Title -->
        <div class="mb-10 fade-in">
          <h1 class="text-4xl font-bold tracking-tight">
            Referral Network <span class="text-emerald-500">.</span>
          </h1>
          <p class="text-slate-400 mt-2">
            Invite friends and earn passive mining rewards.
          </p>
        </div>

        <!-- Referral Stats -->
        <section
          class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12 fade-in"
          style="animation-delay: 0.1s"
        >
          <div
            class="glass-card p-6 rounded-3xl relative overflow-hidden group"
          >
            <div
              class="absolute -right-4 -top-4 w-24 h-24 bg-blue-500/10 rounded-full blur-2xl group-hover:bg-blue-500/20 transition-all"
            ></div>
            <h3
              class="text-slate-400 text-sm font-medium flex items-center gap-2"
            >
              <span class="w-2 h-2 rounded-full bg-blue-500"></span> Total
              Referrals
            </h3>
            <div class="mt-4">
              <span class="text-3xl font-bold text-white" id="total-referrals"
                >0</span
              >
              <span class="text-slate-500 text-sm ml-1">Users</span>
            </div>
          </div>

          <div
            class="glass-card p-6 rounded-3xl relative overflow-hidden group"
          >
            <div
              class="absolute -right-4 -top-4 w-24 h-24 bg-emerald-500/10 rounded-full blur-2xl group-hover:bg-emerald-500/20 transition-all"
            ></div>
            <h3
              class="text-slate-400 text-sm font-medium flex items-center gap-2"
            >
              <span class="w-2 h-2 rounded-full bg-emerald-500"></span> Total
              Earnings
            </h3>
            <div class="mt-4">
              <span class="text-3xl font-bold text-white" id="earned-referrals"
                >0.00</span
              >
              <span class="text-emerald-500 text-sm ml-1 font-bold">CCOX</span>
            </div>
          </div>

          <div
            class="glass-card p-6 rounded-3xl relative overflow-hidden group"
          >
            <div
              class="absolute -right-4 -top-4 w-24 h-24 bg-purple-500/10 rounded-full blur-2xl group-hover:bg-purple-500/20 transition-all"
            ></div>
            <h3
              class="text-slate-400 text-sm font-medium flex items-center gap-2"
            >
              <span class="w-2 h-2 rounded-full bg-purple-500"></span> Link
              Clicks
            </h3>
            <div class="mt-4">
              <span class="text-3xl font-bold text-white" id="referral-clicks"
                >0</span
              >
              <span class="text-slate-500 text-sm ml-1">Hits</span>
            </div>
          </div>
        </section>

        <!-- Link Section -->
        <section
          class="glass-card p-8 rounded-3xl mb-12 border border-emerald-500/20 relative overflow-hidden fade-in"
          style="animation-delay: 0.2s"
        >
          <div
            class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-emerald-500 to-blue-500"
          ></div>
          <h2
            class="text-2xl font-bold text-white mb-6 flex items-center gap-3"
          >
            <span class="text-2xl">üöÄ</span> Your Unique Invite Link
          </h2>

          <div class="flex flex-col md:flex-row items-center gap-4 mb-8">
            <input
              id="referral-link-input"
              type="text"
              value="Loading link..."
              class="w-full bg-slate-900/50 text-emerald-400 font-mono text-sm border border-slate-700 rounded-2xl px-6 py-4 focus:outline-none focus:border-emerald-500 transition shadow-inner"
              readonly
            />

            <button
              onclick="copyReferralLink()"
              class="w-full md:w-auto btn-primary text-white font-bold px-8 py-4 rounded-2xl transition hover:scale-105 active:scale-95 whitespace-nowrap shadow-lg shadow-emerald-500/20"
            >
              Copy Link
            </button>
          </div>

          <h2
            class="text-2xl font-bold text-white mb-6 flex items-center gap-3"
          >
            <span class="text-2xl">üéüÔ∏è</span> Your Invite Code
          </h2>

          <div class="flex flex-col md:flex-row items-center gap-4">
            <input
              id="referral-code-input"
              type="text"
              value="Loading..."
              class="w-full bg-slate-900/50 text-blue-400 font-mono text-sm border border-slate-700 rounded-2xl px-6 py-4 focus:outline-none focus:border-blue-500 transition shadow-inner"
              readonly
            />

            <button
              onclick="copyReferralCode()"
              class="w-full md:w-auto bg-slate-800 hover:bg-slate-700 border border-slate-700 text-white font-bold px-8 py-4 rounded-2xl transition hover:scale-105 active:scale-95 whitespace-nowrap"
            >
              Copy Code
            </button>
          </div>

          <p class="text-sm text-slate-400 mt-4 flex items-center gap-2">
            <svg
              class="w-4 h-4 text-emerald-500"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
              ></path>
            </svg>
            Share this link with friends and enjoy
            <span class="text-emerald-400 font-bold">mining rewards!</span> 
            
          </p>
        </section>

        <!-- Recent Referrals -->
        <section class="fade-in" style="animation-delay: 0.4s">
          <h2 class="text-xl font-bold text-white mb-6">Network Activity</h2>
          <div
            class="glass-card rounded-3xl overflow-hidden border border-slate-800"
          >
            <div class="overflow-x-auto">
              <table class="w-full text-left">
                <thead>
                  <tr
                    class="bg-slate-800/50 text-slate-400 text-xs uppercase tracking-widest"
                  >
                    <th class="px-6 py-4 font-semibold">Username</th>
                    <th class="px-6 py-4 font-semibold">Joined Date</th>
                    <th class="px-6 py-4 font-semibold">Bonus Earned</th>
                    <th class="px-6 py-4 font-semibold">Status</th>
                  </tr>
                </thead>
                <tbody
                  class="divide-y divide-slate-800 text-sm"
                  id="recent-referrals-body"
                >
                  <!-- Dynamic content will be loaded here -->
                  <tr>
                    <td
                      colspan="4"
                      class="px-6 py-8 text-center text-slate-500 italic"
                    >
                      Loading network data...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>
      </main>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <script src="../assets/js/supabase-config.js"></script>
    <script src="../assets/js/app.js"></script>
    <script>
      // Toast function
      function showToast(msg, type = "success") {
        const toast = document.getElementById("toast");
        const toastMsg = document.getElementById("toast-msg");
        if (toast && toastMsg) {
          toastMsg.innerText = msg;
          toast.classList.remove(
            "bg-emerald-600",
            "border-emerald-400",
            "bg-red-600",
            "border-red-400"
          );
          if (type === "error") {
            toast.classList.add("bg-red-600", "border-red-400");
          } else {
            toast.classList.add("bg-emerald-600", "border-emerald-400");
          }
          toast.classList.add("opacity-100");
          setTimeout(() => {
            toast.classList.remove("opacity-100");
          }, 3000);
        }
      }

      // Load referral data when page loads
      document.addEventListener("DOMContentLoaded", async function () {
        // Load sidebar/header if using app.js loader (optional)
        if (typeof loadHTML === "function") {
          loadHTML("#header", "../components/header.html");
          loadHTML("#sidebar", "../components/sidebar.html");
        }

        try {
          const {
            data: { user },
          } = await window.supabase.auth.getUser();
          if (!user) {
            window.location.href = "login.html";
            return;
          }

          // Load referral stats
          const stats = await window.SupabaseConfig.getReferralStats(user.id);
          document.getElementById("total-referrals").textContent =
            stats.totalReferrals;
          document.getElementById("earned-referrals").textContent =
            stats.totalEarned.toFixed(2) + " CCOX";
          document.getElementById("referral-clicks").textContent =
            stats.referralClicks;

          // Load user's referral code and set link
          const referralCode = await window.SupabaseConfig.getUserReferralCode(
            user.id
          );

          // Set explicit domain for referral link
          const referralLink = `https://ccox.network/public/login.html?ref=${referralCode}`;

          document.getElementById("referral-link-input").value = referralLink;
          document.getElementById("referral-code-input").value = referralCode;

          // Load recent referrals
          const recentReferrals =
            await window.SupabaseConfig.getRecentReferrals(user.id);
          const tbody = document.getElementById("recent-referrals-body");
          tbody.innerHTML = "";

          if (recentReferrals.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="4" class="px-6 py-8 text-center text-slate-500 italic">No referrals yet. Share your link to start earning!</td></tr>';
          } else {
            recentReferrals.forEach((ref) => {
              const row = document.createElement("tr");
              row.className = "hover:bg-slate-800/30 transition-colors";
              row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap font-medium text-white">${
                  ref.referred_user.username
                }</td>
                <td class="px-6 py-4 whitespace-nowrap text-slate-400">${new Date(
                  ref.created_at
                ).toLocaleDateString()}</td>
                <td class="px-6 py-4 whitespace-nowrap text-emerald-400 font-bold">+${ref.bonus_amount.toFixed(
                  2
                )} CCOX</td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-emerald-500/10 text-emerald-400 border border-emerald-500/20">Active</span>
                </td>
              `;
              tbody.appendChild(row);
            });
          }
        } catch (error) {
          console.error("Error loading referral data:", error);
          showToast("Error loading referral data", "error");
        }
      });

      function copyReferralLink() {
        const link = document.getElementById("referral-link-input").value;
        navigator.clipboard.writeText(link);
        showToast("Referral link copied!", "success");
      }

      function copyReferralCode() {
        const code = document.getElementById("referral-code-input").value;
        navigator.clipboard.writeText(code);
        showToast("Referral code copied!", "success");
      }
    </script>
  </body>
</html>
